<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å»¶è¿ŸæŠ˜æ‰£å®éªŒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .game-container {
            width: 1000px;
            margin: 0 auto;
            position: relative;
        }

        .option {
            transition: all 0.3s ease;
            transform-origin: center;
        }

        .option:hover {
            transform: scale(1.05);
            background-color: rgba(255, 255, 255, 0.1);
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        .pulse {
            animation: pulse 0.5s ease-in-out;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 1024px) {
            .game-container {
                width: 95%;
                padding: 4px;
            }
        }
    </style>
</head>

<body class="bg-blue-50 min-h-screen py-8">
    <!-- ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º -->
    <div id="participant-info" class="max-w-2xl mx-auto mb-4 bg-white rounded-lg p-4">
        <div class="flex justify-between items-center">
            <div>
                <p class="text-gray-600">å‚ä¸è€…: <span id="participant-name" class="font-medium"></span></p>
                <p class="text-gray-600">ID: <span id="participant-id" class="font-medium"></span></p>
            </div>
            <button onclick="window.location.href='../homepage_cogame.html'"
                class="text-blue-600 hover:text-blue-800 text-sm">
                è¿”å›ä¸»é¡µ
            </button>
        </div>
    </div>

    <div class="game-container bg-white rounded-2xl shadow-lg p-8">
        <!-- æŒ‡å¯¼è¯­å±å¹• -->
        <div id="intro-screen" class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-4 text-blue-600">ğŸ’° å»¶è¿ŸæŠ˜æ‰£å®éªŒ ğŸ’°</h1>
            <p class="text-lg text-gray-600 mb-6">
                åœ¨æ¥ä¸‹æ¥çš„å®éªŒä¸­ï¼Œæ‚¨éœ€è¦åœ¨ä¸¤ä¸ªé€‰é¡¹ä¹‹é—´åšå‡ºé€‰æ‹©ï¼š<br>
                ä¸€ä¸ªé€‰é¡¹æ˜¯ä»Šå¤©è·å¾—ä¸€å®šé‡‘é¢ï¼Œå¦ä¸€ä¸ªé€‰é¡¹æ˜¯åœ¨æœªæ¥æŸä¸€å¤©è·å¾—ä¸€å®šé‡‘é¢ã€‚<br>
                è¯·æ ¹æ®æ‚¨çš„çœŸå®åå¥½åšå‡ºé€‰æ‹©ã€‚<br><br>
                <span class="font-bold text-blue-600">
                    å®éªŒç»“æŸåï¼Œæˆ‘ä»¬ä¼šéšæœºæŠ½å–ä¸€ä¸ªå›åˆçš„é€‰æ‹©æ¥å®ç°å¥–åŠ±å‘æ”¾ã€‚<br>
                    å› æ­¤è¯·è®¤çœŸå¯¹å¾…æ¯ä¸€ä¸ªé€‰æ‹©ï¼
                </span>
            </p>
            <button id="start-button" class="px-8 py-4 bg-blue-500 text-white text-xl rounded-xl 
                           hover:bg-blue-600 transition-colors">
                å¼€å§‹å®éªŒ ğŸ®
            </button>
        </div>

        <!-- å®éªŒå±å¹• -->
        <div id="task-screen" class="hidden">
            <!-- è¿›åº¦æ˜¾ç¤º -->
            <div class="text-center mb-6">
                <div class="text-2xl font-bold">
                    <span class="text-purple-500">è¿›åº¦: <span id="trial-progress">0/26</span></span>
                </div>
            </div>

            <!-- é€‰é¡¹åŒºåŸŸ -->
            <div class="flex justify-center items-center space-x-12 my-8">
                <div id="option-left" class="option w-64 h-40 border-2 border-blue-500 rounded-xl 
                                          flex flex-col items-center justify-center cursor-pointer
                                          hover:bg-blue-50 transition-all">
                    <div class="amount text-3xl font-bold text-blue-600 mb-2">Â¥10</div>
                    <div class="time text-xl text-gray-600">ä»Šå¤©</div>
                </div>
                <div id="option-right" class="option w-64 h-40 border-2 border-blue-500 rounded-xl 
                                           flex flex-col items-center justify-center cursor-pointer
                                           hover:bg-blue-50 transition-all">
                    <div class="amount text-3xl font-bold text-blue-600 mb-2">Â¥11</div>
                    <div class="time text-xl text-gray-600">1å¤©å</div>
                </div>
            </div>

            <div id="fixation" class="hidden text-6xl font-bold text-center">+</div>
        </div>

        <!-- ç»“æœå±å¹• -->
<!-- ç»“æœå±å¹• -->
<div id="results-screen" class="hidden text-center">
    <h2 class="text-3xl font-bold text-blue-600 mb-6">å®éªŒå®Œæˆï¼</h2>
    <div class="max-w-2xl mx-auto bg-gray-50 rounded-xl p-6 mb-6">
        <h3 class="text-2xl font-bold text-gray-700 mb-4">æ‚¨çš„å»¶è¿ŸæŠ˜æ‰£ç‡</h3>
        <p id="k-value" class="text-3xl font-bold text-green-600 mb-4"></p>
        <p id="interpretation" class="text-lg text-gray-600"></p>
    </div>
    <!-- Add save status message -->
    <div id="save-status" class="max-w-2xl mx-auto bg-gray-50 rounded-xl p-4 mb-6 hidden">
        <p id="save-message" class="text-lg font-semibold"></p>
    </div>
</div>

<script>
    // ç”¨æˆ·æ•°æ®ç®¡ç†ç±»
    class ParticipantManager {
        constructor() {
            this.participantData = this.getParticipantData();
            this.validateParticipant();
            this.saveParticipantData();
        }

        getParticipantData() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlData = {
                participantId: urlParams.get('participantId'),
                name: urlParams.get('name'),
                age: urlParams.get('age'),
                gender: urlParams.get('gender'),
                education: urlParams.get('education')
            };

            if (urlData.participantId) {
                return urlData;
            }

            const storedData = localStorage.getItem('participantData');
            return storedData ? JSON.parse(storedData) : null;
        }

        saveParticipantData() {
            if (this.participantData) {
                localStorage.setItem('participantData',
                    JSON.stringify(this.participantData));

                const history = JSON.parse(
                    localStorage.getItem('participationHistory') || '[]'
                );
                history.push({
                    participantId: this.participantData.participantId,
                    taskName: 'delay_discounting',
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('participationHistory',
                    JSON.stringify(history));
            }
        }

        validateParticipant() {
            if (!this.participantData || !this.participantData.participantId) {
                window.location.href = '../homepage_cogame.html';
            }
        }

        getData() {
            return this.participantData;
        }
    }

    // å®éªŒçŠ¶æ€ç®¡ç†
    const gameState = {
        active: false,
        currentTrial: 0,
        maxTrials: 26,
        participant: null,
        trials: [],
        responses: [],
        startTime: null,
        trialStartTime: null,
        selectedTrial: null,
        selectedResponse: null
    };

    // å®éªŒæ§åˆ¶å‡½æ•°
    function showScreen(screenId) {
        ['intro-screen', 'task-screen', 'results-screen'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
        document.getElementById(screenId).classList.remove('hidden');
    }

    function updateTrialDisplay() {
        document.getElementById('trial-progress').textContent =
            `${gameState.currentTrial}/${gameState.maxTrials}`;
    }

    function showFixation() {
        const taskScreen = document.getElementById('task-screen');
        const optionsContainer = taskScreen.querySelector('.flex');
        const fixation = document.getElementById('fixation');

        optionsContainer.classList.add('hidden');
        fixation.classList.remove('hidden');

        setTimeout(() => {
            fixation.classList.add('hidden');
            optionsContainer.classList.remove('hidden');
            showTrial();
            gameState.trialStartTime = Date.now();
        }, 500);
    }

    function showTrial() {
        if (gameState.currentTrial >= gameState.maxTrials) {
            endExperiment();
            return;
        }

        const trial = gameState.trials[gameState.currentTrial];

        const leftOption = document.getElementById('option-left');
        const rightOption = document.getElementById('option-right');

        leftOption.querySelector('.amount').textContent = `Â¥${trial.leftAmount}`;
        leftOption.querySelector('.time').textContent = trial.leftDelay;
        rightOption.querySelector('.amount').textContent = `Â¥${trial.rightAmount}`;
        rightOption.querySelector('.time').textContent = trial.rightDelay;

        updateTrialDisplay();
    }

    function recordResponse(choice) {
        const trial = gameState.trials[gameState.currentTrial];
        const response = {
            participantId: gameState.participant.participantId,
            name: gameState.participant.name,
            age: gameState.participant.age,
            gender: gameState.participant.gender,
            education: gameState.participant.education,
            trialNumber: gameState.currentTrial + 1,
            leftAmount: trial.leftAmount,
            leftDelay: trial.leftDelay,
            rightAmount: trial.rightAmount,
            rightDelay: trial.rightDelay,
            choice: choice,
            rt: Date.now() - gameState.trialStartTime,
            timestamp: new Date().toISOString()
        };

        gameState.responses.push(response);
        gameState.currentTrial++;
        showFixation();
    }

    function calculateDiscountRate() {
        const presentValue = 10;
        let kValues = [];

        gameState.responses.forEach(response => {
            let delay, amount;
            if (response.choice === 'right' && response.rightDelay !== 'ä»Šå¤©') {
                delay = parseInt(response.rightDelay);
                amount = response.rightAmount;
            } else if (response.choice === 'left' && response.leftDelay !== 'ä»Šå¤©') {
                delay = parseInt(response.leftDelay);
                amount = response.leftAmount;
            }

            if (delay > 0) {
                const k = (amount / presentValue - 1) / delay;
                kValues.push(k);
            }
        });

        return kValues.length > 0 ?
            kValues.reduce((a, b) => a + b, 0) / kValues.length : 0;
    }

    function interpretDiscountRate(k) {
        if (k < 0.001) {
            return "æ‚¨å¯¹æœªæ¥å¥–åŠ±çš„è€å¿ƒç¨‹åº¦å¾ˆé«˜ï¼Œæ›´å€¾å‘äºç­‰å¾…æ›´å¤§çš„æ”¶ç›Šã€‚";
        } else if (k < 0.01) {
            return "æ‚¨å¯¹æœªæ¥å¥–åŠ±æœ‰è¾ƒå¥½çš„è€å¿ƒï¼Œåœ¨å³æ—¶å’Œå»¶è¿Ÿå¥–åŠ±ä¹‹é—´ä¿æŒç€å¹³è¡¡ã€‚";
        } else if (k < 0.1) {
            return "æ‚¨å¯¹å³æ—¶å¥–åŠ±çš„åå¥½è¾ƒå¼ºï¼Œä½†ä»ä¼šè€ƒè™‘æœªæ¥æ”¶ç›Šã€‚";
        } else {
            return "æ‚¨å¼ºçƒˆåå¥½å³æ—¶å¥–åŠ±ï¼Œç›¸å¯¹ä¸å¤ªæ„¿æ„ç­‰å¾…æœªæ¥çš„æ›´å¤§æ”¶ç›Šã€‚";
        }
    }

    async function saveData() {
        const saveStatus = document.getElementById('save-status');
        const saveMessage = document.getElementById('save-message');
        saveStatus.classList.remove('hidden');
        saveMessage.className = 'text-lg font-semibold text-blue-600';
        saveMessage.textContent = 'æ­£åœ¨ä¿å­˜æ•°æ®...';

        try {
            const headers = [
                'participantId',
                'name',
                'age',
                'gender',
                'education',
                'trialNumber',
                'leftAmount',
                'leftDelay',
                'rightAmount',
                'rightDelay',
                'choice',
                'rt',
                'timestamp',
                'discountRate',
                'selectedTrial',
                'selectedReward'
            ];

            const k = calculateDiscountRate();
            const csvContent = [
                headers.join(','),
                ...gameState.responses.map(r => {
                    const isSelected = gameState.selectedResponse &&
                        r.trialNumber === gameState.selectedResponse.trialNumber;
                    const selectedReward = isSelected ?
                        (r.choice === 'left' ? r.leftAmount : r.rightAmount) : '';

                    const row = [
                        ...headers.slice(0, -3).map(header => r[header]),
                        k,
                        isSelected ? 'yes' : 'no',
                        selectedReward
                    ];
                    return row.join(',');
                })
            ].join('\n');


            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `delay_discounting_${gameState.participant.name}_${gameState.participant.participantId}_${new Date().getTime()}.csv`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            saveMessage.className = 'text-lg font-semibold text-green-600';
            saveMessage.textContent = 'æ•°æ®å·²æˆåŠŸä¿å­˜ï¼';

            setTimeout(() => {
                saveStatus.classList.add('hidden');
            }, 3000);

        } catch (error) {
            console.error('ä¿å­˜æ•°æ®æ—¶å‡ºé”™:', error);
            saveMessage.className = 'text-lg font-semibold text-red-600';
            saveMessage.textContent = 'ä¿å­˜æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
        }
    }

    function startExperiment() {
        gameState.active = true;
        gameState.currentTrial = 0;
        gameState.startTime = new Date();
        gameState.responses = [];

        showScreen('task-screen');
        showTrial();
        gameState.trialStartTime = Date.now();
    }

    function endExperiment() {
        gameState.active = false;

        const selectedIndex = Math.floor(Math.random() * gameState.responses.length);
        gameState.selectedTrial = gameState.trials[selectedIndex];
        gameState.selectedResponse = gameState.responses[selectedIndex];

        showScreen('results-screen');

        const k = calculateDiscountRate();
        document.getElementById('k-value').textContent = `k = ${k.toExponential(2)}`;
        document.getElementById('interpretation').textContent = interpretDiscountRate(k);

        const selectedTrialInfo = document.createElement('div');
        selectedTrialInfo.className = 'max-w-2xl mx-auto bg-yellow-50 rounded-xl p-6 mt-6';
        selectedTrialInfo.innerHTML = `
            <h3 class="text-2xl font-bold text-yellow-600 mb-4">éšæœºæŠ½å–å›åˆ</h3>
            <p class="text-lg text-gray-700">
                åœ¨ç¬¬ ${gameState.selectedResponse.trialNumber} ä¸ªå›åˆä¸­ï¼Œæ‚¨é€‰æ‹©äº†
                ${gameState.selectedResponse.choice === 'left' ?
                `ç°åœ¨è·å¾— Â¥${gameState.selectedTrial.leftAmount}` :
                `${gameState.selectedTrial.rightDelay}è·å¾— Â¥${gameState.selectedTrial.rightAmount}`}
            </p>
            <p class="text-lg font-bold text-green-600 mt-2">
                è¿™å°†æ˜¯æ‚¨åœ¨æœ¬å®éªŒä¸­è·å¾—çš„å®é™…å¥–åŠ±ï¼
            </p>
        `;

        document.getElementById('results-screen').insertBefore(
            selectedTrialInfo,
            document.getElementById('save-status')
        );

        // Automatically save data after a brief delay
        setTimeout(saveData, 500);
    }

    // äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
        // åˆå§‹åŒ–å‚ä¸è€…ç®¡ç†å™¨å’Œæ•°æ®
        const participantManager = new ParticipantManager();
        gameState.participant = participantManager.getData();

        // æ˜¾ç¤ºå‚ä¸è€…ä¿¡æ¯
        document.getElementById('participant-name').textContent = gameState.participant.name;
        document.getElementById('participant-id').textContent = gameState.participant.participantId;

        // æŒ‰é’®äº‹ä»¶ç›‘å¬
        document.getElementById('start-button').addEventListener('click', startExperiment);

        // é€‰é¡¹ç‚¹å‡»äº‹ä»¶
        document.getElementById('option-left').addEventListener('click', () => {
            if (gameState.active) {
                document.getElementById('option-left').classList.add('pulse');
                setTimeout(() => {
                    document.getElementById('option-left').classList.remove('pulse');
                    recordResponse('left');
                }, 200);
            }
        });

        document.getElementById('option-right').addEventListener('click', () => {
            if (gameState.active) {
                document.getElementById('option-right').classList.add('pulse');
                setTimeout(() => {
                    document.getElementById('option-right').classList.remove('pulse');
                    recordResponse('right');
                }, 200);
            }
        });

        // é”®ç›˜æ§åˆ¶
        document.addEventListener('keydown', (event) => {
            if (!gameState.active) return;

            switch (event.key) {
                case 'ArrowLeft':
                case 'f':
                case 'F':
                    event.preventDefault();
                    document.getElementById('option-left').click();
                    break;
                case 'ArrowRight':
                case 'j':
                case 'J':
                    event.preventDefault();
                    document.getElementById('option-right').click();
                    break;
            }
        });

        // é˜²æ­¢å®éªŒåŒºåŸŸå³é”®èœå•
        document.querySelector('.game-container').addEventListener('contextmenu',
            (e) => e.preventDefault()
        );

        // çª—å£ç„¦ç‚¹å¤„ç†
        window.addEventListener('blur', () => {
            if (gameState.active) {
                document.getElementById('option-left').style.pointerEvents = 'none';
                document.getElementById('option-right').style.pointerEvents = 'none';
            }
        });

        window.addEventListener('focus', () => {
            if (gameState.active) {
                document.getElementById('option-left').style.pointerEvents = 'auto';
                document.getElementById('option-right').style.pointerEvents = 'auto';
            }
        });

        // åˆå§‹åŒ–trialsæ•°ç»„
        gameState.trials = [
            { leftAmount: 10, leftDelay: 'ä»Šå¤©', rightAmount: 11, rightDelay: '1å¤©å' },
            { leftAmount: 10, leftDelay: 'ä»Šå¤©', rightAmount: 29, rightDelay: '90å¤©å' },
            { leftAmount: 14, leftDelay: '14å¤©å', rightAmount: 10, rightDelay: 'ä»Šå¤©' },
            { leftAmount: 10, leftDelay: 'ä»Šå¤©', rightAmount: 11, rightDelay: '1å¤©å' },
            { leftAmount: 10, leftDelay: 'ä»Šå¤©', rightAmount: 20, rightDelay: '60å¤©å' },
            { leftAmount: 17, rightDelay: '7å¤©å', rightAmount: 10, rightDelay: 'ä»Šå¤©' },
            { leftAmount: 10, leftDelay: 'ä»Šå¤©', rightAmount: 26, rightDelay: '90å¤©å' },
            { leftAmount: 10, leftDelay: 'ä»Šå¤©', rightAmount: 26, rightDelay: '1å¤©å' },
            { leftAmount: 10, leftDelay: 'ä»Šå¤©', rightAmount: 20, rightDelay: '5å¤©å' },
            { leftAmount: 14, leftDelay: '7å¤©å', rightAmount: 10, rightDelay: 'ä»Šå¤©' },
            { leftAmount: 10, leftDelay: 'ä»Šå¤©', rightAmount: 26, rightDelay: '3å¤©å' },
            { leftAmount: 10, leftDelay: 'ä»Šå¤©', rightAmount: 17, rightDelay: '5å¤©å' },
            { leftAmount: 10, leftDelay: 'ä»Šå¤©', rightAmount: 20, rightDelay: '90å¤©å' },
            { leftAmount: 11, leftDelay: '7å¤©å', rightAmount: 10, rightDelay: 'ä»Šå¤©' },
            { leftAmount: 17, leftDelay: '60å¤©å', rightAmount: 10, rightDelay: 'ä»Šå¤©' },
            { leftAmount: 10, leftDelay: 'ä»Šå¤©', rightAmount: 20, rightDelay: '1å¤©å' },
            { leftAmount: 17, leftDelay: '1å¤©å', rightAmount: 10, rightDelay: 'ä»Šå¤©' },
            { leftAmount: 23, leftDelay: '7å¤©å', rightAmount: 10, rightDelay: 'ä»Šå¤©' },
            { leftAmount: 10, leftDelay: 'ä»Šå¤©', rightAmount: 14, rightDelay: '1å¤©å' },
            { leftAmount: 10, leftDelay: 'ä»Šå¤©', rightAmount: 14, rightDelay: '90å¤©å' },
            { leftAmount: 23, leftDelay: '60å¤©å', rightAmount: 10, rightDelay: 'ä»Šå¤©' },
            { leftAmount: 23, leftDelay: '14å¤©å', rightAmount: 10, rightDelay: 'ä»Šå¤©' },
            { leftAmount: 10, leftDelay: 'ä»Šå¤©', rightAmount: 14, rightDelay: '60å¤©å' },
            { leftAmount: 20, leftDelay: '7å¤©å', rightAmount: 10, rightDelay: 'ä»Šå¤©' },
            { leftAmount: 14, leftDelay: '3å¤©å', rightAmount: 10, rightDelay: 'ä»Šå¤©' },
            { leftAmount: 11, leftDelay: '90å¤©å', rightAmount: 10, rightDelay: 'ä»Šå¤©' }
        ];

        // Randomize trials order
        for (let i = gameState.trials.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [gameState.trials[i], gameState.trials[j]] = [gameState.trials[j], gameState.trials[i]];
        }
    });
</script>
</body>

</html>